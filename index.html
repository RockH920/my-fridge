<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>â˜ï¸ é›²ç«¯å†°ç®±ç®¡å®¶</title>
    <style>
        :root {
            --primary: #4a90e2;
            --bg: #f5f7fa;
            --card: #ffffff;
            --text: #2c3e50;
        }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); padding: 20px; margin: 0; }
        .container { max-width: 900px; margin: 0 auto; background: var(--card); padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: var(--primary); margin-top: 0; }
        
        /* æ§åˆ¶å€å¡Šä½ˆå±€ */
        .control-panel {
            display: grid;
            gap: 15px;
            background: #eef2f7;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .input-row, .filter-row {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        /* è¼¸å…¥æ¡†æ¨£å¼ */
        input, select {
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 6px;
            flex: 1; /* è‡ªå‹•å¡«æ»¿å¯¬åº¦ */
        }
        
        /* æŒ‰éˆ• */
        button { cursor: pointer; border: none; padding: 10px 20px; border-radius: 6px; font-weight: bold; color: white; transition: 0.2s; }
        #addBtn { background: var(--primary); flex: 0 0 auto; }
        #addBtn:hover { background: #357abd; }
        .del-btn { background: #e74c3c; padding: 5px 12px; font-size: 0.9em; }
        
        /* è¡¨æ ¼ */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: var(--primary); color: white; }
        
        /* åˆ†é¡æ¨™ç±¤é¡è‰² */
        .tag { padding: 3px 8px; border-radius: 12px; font-size: 0.85em; background: #ddd; }
        .tag-meat { background: #ffcccc; color: #a94442; }
        .tag-veg { background: #dff0d8; color: #3c763d; }
        .tag-drink { background: #d9edf7; color: #31708f; }
        .tag-other { background: #fcf8e3; color: #8a6d3b; }

        /* ç‹€æ…‹é¡è‰² */
        .status-ok { color: #27ae60; font-weight: bold; }
        .status-soon { color: #f39c12; font-weight: bold; }
        .status-expired { color: #c0392b; font-weight: bold; }

        /* æ‰‹æ©Ÿç‰ˆå„ªåŒ– */
        @media (max-width: 600px) {
            .input-row, .filter-row { flex-direction: column; }
            button { width: 100%; }
        }
        
        #loading { text-align: center; color: #888; display: none; }
    </style>
</head>
<body>

<div class="container">
    <h1>â˜ï¸ é›²ç«¯å†°ç®±ç®¡å®¶</h1>

    <div class="control-panel">
        <h3>â• æ–°å¢ç‰©å“</h3>
        <div class="input-row">
            <input type="text" id="inName" placeholder="åç¨± (å¦‚: é›è›‹)">
            <select id="inCat">
                <option value="meat">ğŸ¥© è‚‰é¡/æµ·é®®</option>
                <option value="veg">ğŸ¥¦ è”¬èœ/æ°´æœ</option>
                <option value="drink">ğŸ§ƒ é£²æ–™/ä¹³å“</option>
                <option value="other">ğŸ¥« å…¶ä»–/é†¬æ–™</option>
            </select>
            <input type="number" id="inQty" placeholder="æ•¸é‡" value="1" style="flex: 0.5;">
            <input type="date" id="inDate">
            <button id="addBtn">åŠ å…¥</button>
        </div>
    </div>

    <div class="control-panel" style="background: white; border: 1px solid #eee;">
        <div class="filter-row">
            <input type="text" id="searchBox" placeholder="ğŸ” æœå°‹å†°ç®±å…§å®¹...">
            <select id="filterCat" style="flex: 0.5;">
                <option value="all">å…¨éƒ¨ç¨®é¡</option>
                <option value="meat">ğŸ¥© è‚‰é¡/æµ·é®®</option>
                <option value="veg">ğŸ¥¦ è”¬èœ/æ°´æœ</option>
                <option value="drink">ğŸ§ƒ é£²æ–™/ä¹³å“</option>
                <option value="other">ğŸ¥« å…¶ä»–/é†¬æ–™</option>
            </select>
        </div>
    </div>

    <p id="loading">æ­£åœ¨é€£ç·šè‡³é›²ç«¯è³‡æ–™åº«...</p>

    <table>
        <thead>
            <tr>
                <th>åˆ†é¡</th>
                <th>åç¨±</th>
                <th>æ•¸é‡</th>
                <th>ç‹€æ…‹</th>
                <th>æ“ä½œ</th>
            </tr>
        </thead>
        <tbody id="listBody"></tbody>
    </table>
</div>

<script type="module">
    // 1. å¼•å…¥å¿…è¦çš„ Firebase å‡½å¼
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // ==========================================
    // 2. è¨­å®šå€ï¼šè«‹å°‡ä¸‹æ–¹çš„ firebaseConfig æ›¿æ›æˆä½ è‡ªå·±çš„ï¼
    // ==========================================
    const firebaseConfig = {
        apiKey: "AIzaSyCQnrmh80AWghQA8N1_vO8wLYfAEVUi90w",
  	authDomain: "a101-91812.firebaseapp.com",
  	projectId: "a101-91812",
  	storageBucket: "a101-91812.firebasestorage.app",
  	messagingSenderId: "219743115164",
  	appId: "1:219743115164:web:88c78b9170bcc6ed07da59",
  	measurementId: "G-047EBB1R3X"
    };
    // ==========================================

    // åˆå§‹åŒ– Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const fridgeCol = collection(db, "fridge_items");

    // UI åƒè€ƒ
    const listBody = document.getElementById('listBody');
    const searchBox = document.getElementById('searchBox');
    const filterCat = document.getElementById('filterCat');
    const loading = document.getElementById('loading');

    // æœ¬åœ°æš«å­˜è³‡æ–™ (ç”¨æ–¼æœå°‹ç¯©é¸)
    let localItems = [];

    // è¨­å®šé è¨­æ—¥æœŸç‚ºä»Šå¤©
    document.getElementById('inDate').value = new Date().toISOString().split('T')[0];

    // --- åŠŸèƒ½ 1: ç›£è½é›²ç«¯è³‡æ–™ (å³æ™‚åŒæ­¥) ---
    loading.style.display = 'block';
    
    // ä½¿ç”¨ onSnapshot å¯ä»¥å³æ™‚æ”¶åˆ°è³‡æ–™åº«è®Šæ›´ (åˆ¥äººæ–°å¢ï¼Œä½ æœƒé¦¬ä¸Šçœ‹åˆ°)
    const q = query(fridgeCol, orderBy("date")); // ä¾ç…§æ—¥æœŸæ’åº
    
    onSnapshot(q, (snapshot) => {
        localItems = snapshot.docs.map(doc => ({
            id: doc.id,
            ...doc.data()
        }));
        loading.style.display = 'none';
        renderTable(); // è³‡æ–™æ›´æ–°æ™‚é‡ç¹ªè¡¨æ ¼
    }, (error) => {
        console.error("è®€å–éŒ¯èª¤:", error);
        loading.innerText = "è®€å–å¤±æ•—ï¼Œè«‹æª¢æŸ¥ Firebase è¨­å®š (Console)";
    });

    // --- åŠŸèƒ½ 2: æ–°å¢è³‡æ–™ ---
    document.getElementById('addBtn').addEventListener('click', async () => {
        const name = document.getElementById('inName').value;
        const cat = document.getElementById('inCat').value;
        const qty = document.getElementById('inQty').value;
        const date = document.getElementById('inDate').value;

        if (!name || !date) { alert("è«‹è¼¸å…¥åç¨±èˆ‡æ—¥æœŸ"); return; }

        try {
            document.getElementById('addBtn').disabled = true;
            document.getElementById('addBtn').innerText = "å„²å­˜ä¸­...";
            
            await addDoc(fridgeCol, {
                name, cat, qty, date,
                createdAt: new Date()
            });

            // æ¸…ç©ºè¼¸å…¥
            document.getElementById('inName').value = '';
            document.getElementById('inQty').value = '1';
            document.getElementById('addBtn').disabled = false;
            document.getElementById('addBtn').innerText = "åŠ å…¥";
        } catch (e) {
            console.error("æ–°å¢å¤±æ•—: ", e);
            alert("æ–°å¢å¤±æ•—ï¼Œè«‹æª¢æŸ¥ Console");
        }
    });

    // --- åŠŸèƒ½ 3: åˆªé™¤è³‡æ–™ (éœ€æ›è¼‰åˆ° window æ‰èƒ½è¢« HTML onclick å‘¼å«) ---
    window.deleteItem = async (id) => {
        if(confirm("ç¢ºå®šåƒæ‰æˆ–ä¸Ÿæ£„äº†å—ï¼Ÿ")) {
            await deleteDoc(doc(db, "fridge_items", id));
        }
    };

    // --- åŠŸèƒ½ 4: æ¸²æŸ“è¡¨æ ¼ (å«æœå°‹èˆ‡ç¯©é¸é‚è¼¯) ---
    function renderTable() {
        const searchText = searchBox.value.toLowerCase();
        const catFilter = filterCat.value;

        // ç¯©é¸è³‡æ–™
        const filtered = localItems.filter(item => {
            const matchName = item.name.toLowerCase().includes(searchText);
            const matchCat = catFilter === 'all' || item.cat === catFilter;
            return matchName && matchCat;
        });

        // ç”¢ç”Ÿ HTML
        listBody.innerHTML = filtered.map(item => {
            const status = getStatus(item.date);
            const catLabel = getCatLabel(item.cat);
            return `
                <tr>
                    <td><span class="tag ${catLabel.class}">${catLabel.text}</span></td>
                    <td>${item.name}</td>
                    <td>${item.qty}</td>
                    <td class="${status.class}">${item.text} (${item.date})</td>
                    <td><button class="del-btn" onclick="deleteItem('${item.id}')">å®Œé£Ÿ</button></td>
                </tr>
            `;
        }).join('');
    }

    // è¼”åŠ©: ç‹€æ…‹è¨ˆç®—
    function getStatus(dateStr) {
        const today = new Date();
        today.setHours(0,0,0,0);
        const target = new Date(dateStr);
        const diffDays = Math.ceil((target - today) / (86400000));

        if (diffDays < 0) return { text: `éæœŸ ${Math.abs(diffDays)} å¤©`, class: 'status-expired' };
        if (diffDays <= 3) return { text: `å‰© ${diffDays} å¤©`, class: 'status-soon' };
        return { text: 'æ–°é®®', class: 'status-ok' };
    }

    // è¼”åŠ©: åˆ†é¡æ¨™ç±¤
    function getCatLabel(cat) {
        const map = {
            'meat': { text: 'è‚‰é¡', class: 'tag-meat' },
            'veg':  { text: 'è”¬æœ', class: 'tag-veg' },
            'drink':{ text: 'é£²å“', class: 'tag-drink' },
            'other':{ text: 'å…¶ä»–', class: 'tag-other' }
        };
        return map[cat] || map['other'];
    }

    // --- ç›£è½æœå°‹æ¡†è¼¸å…¥äº‹ä»¶ ---
    searchBox.addEventListener('input', renderTable);
    filterCat.addEventListener('change', renderTable);

</script>

</body>
</html>